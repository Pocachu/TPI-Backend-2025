FROM openliberty/open-liberty:21.0.0.12-full-java11-openj9-ubi

# Copiar archivos de configuración de OpenLiberty
COPY --chown=1001:0 src/main/liberty/config/server.xml /config/
COPY --chown=1001:0 src/main/liberty/config/bootstrap.properties /config/
COPY --chown=1001:0 src/main/liberty/config/jvm.options /config/

# Copiar los drivers de PostgreSQL
COPY --chown=1001:0 src/main/liberty/config/postgresql-42.3.1.jar /opt/ol/wlp/usr/shared/resources/

# Configurar PostgreSQL
ENV POSTGRES_HOST=postgres
ENV POSTGRES_PORT=5432
ENV POSTGRES_DB=tipicos
ENV POSTGRES_USER=postgres
ENV POSTGRES_PASSWORD=postgres

# Copiar el archivo WAR de la aplicación
COPY --chown=1001:0 target/tipicos-tpi135.war /config/apps/

# Ejecutar servidor en modo de desarrollo para permitir reinicio rápido
CMD ["/opt/ol/wlp/bin/server", "run", "defaultServer"]

HEALTHCHECK --start-period=5s --interval=5s --timeout=5s \
  CMD curl -f http://localhost:9080/tipicos-tpi135/api/health || exit 1
